<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <script src="dist/ccl-traj-viz.iife.js"></script>
    <link href="https://unpkg.com/tabulator-tables@5.4.4/dist/css/tabulator.min.css" rel="stylesheet">
    <link href="dist/ccl-traj-viz.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>iw-web-viz</title>
  </head>
  <body>
    <div style="width: fit-content; margin: 0 auto;">
      <video src="/video.mp4" style="width: 800px;"></video>
    </div>
    <div id="app"></div>
    <script>
function loadGzJson(url) {
  return fetch(url)
    .then(response => response.blob())
    .then(compressedBlob => {
      const ds = new DecompressionStream("gzip");
      const decompressedStream = compressedBlob.stream().pipeThrough(ds);
      return new Response(decompressedStream).text();
    })
    .then(text => JSON.parse(text))
    .catch(err => {
      console.error('Failed to load compressed JSON:', err);
    });
}

function loadJson(url) {
  return fetch(url)
    .then(response => response.json())
    .catch(err => {
      console.error('Failed to load JSON', err)
    });
}

const domPromise = new Promise(resolve => {
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", resolve);
  } else {
    resolve();
  }
});

const tableOptions =  [
  {title: "person_id",field: "person_id", headerFilter: "input" },
  {title: "condition", field: "body_orientation", headerFilter: "list", headerFilterFunc: "=", headerFilterParams: {
          values: {Baseline: "Baseline", FaceToFace: "FaceToFace", BackToBack: "BackToBack", FacingOffset: "FacingOffset"}
      }
  },
  {title: "gender", field: "pedestrian_gender", headerFilter: "list", headerFilterFunc: "=", headerFilterParams: {
          values: { Male: "Male", Female: "Female" }
      }
  },
  {title: "transportation", field: "transportation", headerFilter: "list", headerFilterFunc: "=", headerFilterParams: {
          values: {Walking: "Walking", Scooter: "Scooter", Bike: "Bike", Skateboard: "Skateboard"}
      }
  },
  {title: "direction", field: "pedestrian_direction", headerFilter: "list", headerFilterFunc: "=", headerFilterParams: {
          values: {Left: "Left", Right: "Right"}
      }
  },
  {title: "pedestrian_on_phone", field: "pedestrian_on_phone"},
  {title: "breach", field: "breach"}
];

const trajectoryDataPromise = loadGzJson("dist/data/experiment_2_trajectory_4video.json.gz");
const metaDataPromise = loadGzJson("dist/data/experiment_2_4video.json.gz");
//const conditionTimingDataPromise = loadJson("data/");
const mapDataPromise = loadJson("dist/data/environments/mural.json");

Promise.all([domPromise, trajectoryDataPromise, metaDataPromise, mapDataPromise])
       .then(([_, trajectoryData, metaData, mapData]) => {
  console.log(domPromise, trajectoryData, metaData, mapData);
  trajectoryData = trajectoryData.filter(d => d.person_id !== 100 && d.person_id != 35 && d.person_id != 173 && d.person_id != 87); // remove bad data
  const video = document.querySelector("video");
  const renderConfig = {
    xlim: [-1500, 1000],
    ylim: [-500, 1000],
    width: 1920, height: 1080,
    background: mapData,
    windowGroups: [{key: "Baseline", name: "Baseline"}, {key: "FaceToFace", name: "Face to face"}, {key: "BackToBack", name: "Back to back"}, {key: "OffsetFacing", name: "45Â° offset facing"}]
  };
  const appElement = document.querySelector("#app");
  appElement.innerHTML = "";
  const controller =  new cclTrajViz.Controller(
                        appElement,
                        trajectoryData,
                        metaData,
                        tableOptions,
                        renderConfig
                      );
  controller.play();
  video.play();

  //---------------------------------------------
  // Actor Controls
  //---------------------------------------------
  const faceToFaceConfig = {
      actor1: {x: -280, y: 0, angle: 90, visible: true},
      actor2: {x: -280, y: 326, angle: 270, visible: true}
  }
  const backToBackConfig = {
      actor1: {x: -280, y: 0, angle: 270, visible: true},
      actor2: {x: -280, y: 326, angle: 90, visible: true}
  }
  const offsetFacing = {
      actor1: {x: -280, y: 0, angle: 135, visible: true},
      actor2: {x: -280, y: 326, angle: 225, visible: true}
  }

  const conditions = {
      "FaceToFace": faceToFaceConfig,
      "BackToBack": backToBackConfig,
      "OffsetFacing": offsetFacing 
  };

  controller.addEventListener("initialized", async () => {
    const actorTexture = await cclTrajViz.loadActorTexture("assets/actor.png");
    const fullViewportActors = new cclTrajViz.Actors(actorTexture, conditions, controller.renderer.fullViewport);
    fullViewportActors.update("FaceToFace");
    const paneActors = Object.keys(controller.renderer.panes)
                             .map(condition => {
                               if (condition === "Baseline") return;
                               const pane = controller.renderer.panes[condition];
                               const paneActors = new cclTrajViz.Actors(actorTexture, conditions, pane);
                               paneActors.update(condition);
                               return paneActors;
                             })

    document.querySelector('#app').querySelector("#sightButton").addEventListener("click", () => {
      fullViewportActors.toggleViewLines();
      paneActors.forEach(pa => pa?.toggleViewLines());
    });

    controller.addEventListener("frameUpdated", (frame) => {
      if (1000 < frame && frame < 2000) {
        console.log(frame);
        fullViewportActors.update("OffsetFacing");
      }
      if (2000 < frame) {
        fullViewportActors.update("BackToBack");
      }
    });
  });

  //---------------------------------------------
  // Color Filters
  //---------------------------------------------

  controller.createColorDropdowns(["condition", "direction", "gender", "breach", "transportation"])
  controller.addEventListener("colorBy", (group) => {
    switch(group) {
      case "none":
        controller.renderer.resetColors();
        controller.updateLegend(null);
        break;
      case "gender":
        const genderMapping = {Male: "#4dbbd5", Female: "#f48f3d"};
        controller.renderer.colorByGroup("pedestrian_gender", genderMapping);
        controller.updateLegend(genderMapping, "Gender")
        break;
      case "condition":
        const conditionMapping = {
          FaceToFace: "#00a087", BackToBack: "#f48f3d",
          OffsetFacing: "#4dbbd5", Baseline: "#000000"
        }
        controller.renderer.colorByGroup("body_orientation", conditionMapping);
        controller.updateLegend(conditionMapping, "Body Orientation Condition");
        break;
      case "breach":
        const breachMapping = {
          0: "#4dbbd5", 1: "#e44c37"
        };
        controller.renderer.colorByGroup("breach", breachMapping);
        controller.updateLegend(breachMapping, "Breaching Outcome");
        break;
      case "direction":
        const directionMapping = {
            Left: "#000000a0", Right: "#0fa18aa0"
        }
        controller.renderer.colorByGroup("pedestrian_direction", directionMapping);
        controller.updateLegend(directionMapping, "Pedestrian Direction");
        break;
      case "transportation":
        const transportationMapping ={
          Skateboard: "#00a087", Scooter: "#f48f3d",
          Bike: "#4dbbd5", Walking: "#000000"
        }
        controller.renderer.colorByGroup("transportation", transportationMapping);
        controller.updateLegend(transportationMapping, "Transportation");
        break;
      default:
        controller.renderer.resetColors();
        break;
    }
  });

  //---------------------------------------------
  // on update
  //---------------------------------------------
  controller.addEventListener("seekedFrame", (frame) => {
    video.currentTime = ((frame+460-32) / 29.97)
  });
  controller.addEventListener("speedChange", (rate) => {
    video.playbackRate = rate;
  });
  controller.addEventListener("play", () => {
    video.play();
  });
  controller.addEventListener("pause", () => {
    video.pause();
  });

  //---------------------------------------------
  // Keybindings
  //---------------------------------------------

  window.addEventListener("keydown", (e) => {
      console.log(e.key);
      switch (e.key) {
          case "Tab":
              e.preventDefault(); // prevent browser focus switch
              controller.renderer.toggleViewMode();
              break;
          case " ": // space
              controller.togglePlay();
              break;
          case "ArrowRight":
              controller.stepForward();
              break;
          case "ArrowLeft":
              controller.stepBackward();
              break;
          case "ArrowUp":
              controller.increaseSpeed();
              break;
          case "ArrowDown":
              controller.decreaseSpeed();
              break;
          default:
              break;
      }
    }
  );

});
    </script>
  </body>
</html>

